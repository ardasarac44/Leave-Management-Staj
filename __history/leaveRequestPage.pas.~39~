unit leaveRequestPage;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Vcl.StdCtrls, Vcl.Grids,dbConnection,
  Vcl.Menus, Vcl.WinXPickers, Vcl.ExtCtrls;

type
  TleaveRequestForm = class(TForm)
    startDateLabel: TLabel;
    endDateLabel: TLabel;
    requestButton: TButton;
    userGrid: TStringGrid;
    showRequestsLabel: TLabel;
    priorityLabel: TLabel;
    startDatePick: TDatePicker;
    endDatePick: TDatePicker;
    priorityButtonGroup: TRadioGroup;
    priorityButton1: TRadioButton;
    priorityButton2: TRadioButton;
    priorityButton3: TRadioButton;

    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    constructor Create(AOwner: TComponent; const userId : integer);
    procedure requestButtonClick(Sender: TObject);
    function checkPriority(): integer;
    function checkAvailableRequests(): boolean;
    procedure insertRequest();
  private

    { Private declarations }
  public
    m_userId: integer;
    { Public declarations }
  end;

var
  leaveRequestForm: TleaveRequestForm;


implementation

{$R *.dfm}

constructor TleaveRequestForm.Create(AOwner: TComponent; const userId: Integer);
begin
  inherited Create(AOwner);
  m_userId := userId;
end;

procedure TleaveRequestForm.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  Application.Terminate;
end;

procedure TleaveRequestForm.FormCreate(Sender: TObject);
var
  j: integer;
    begin
        Self.userGrid.Cells[0,0] := 'ID';
        Self.userGrid.Cells[0,1] := 'First Name';
        Self.userGrid.Cells[0,2] := 'Last Name';
        Self.userGrid.Cells[0,3] := 'Phone';
        Self.userGrid.Cells[0,4] := 'Department';
        Self.userGrid.Cells[0,5] := 'E-mail';
      try
          with dbConnection.dbForm.getEmployeeByIdQ do
            begin
             SetVariable('id', Self.m_userId);
             Execute;
             for j := 0 to 5 do
                begin
                  Self.userGrid.Cells[1,j]  := dbConnection.dbForm.getEmployeeByIdQ.Field(j);

                end;
            end;
          except
            ShowMessage('User not found!');

        dbConnection.dbForm.getEmployeeByIdQ.Close;
      end;
    end;


procedure TleaveRequestForm.requestButtonClick(Sender: TObject);
var
  dt: TDate;
begin
  if checkAvailableRequests() then
  begin

  end
  else
  begin
    ShowMessage('Choose different priority or edit pending requests.');
  end;
  dbConnection.dbForm.requestLeaveQ.Close;
end;

function TleaveRequestForm.checkPriority(): integer;
  begin
    if self.priorityButton1.Checked	= True then
      checkPriority := 1;
    if self.priorityButton2.Checked	= True then
      checkPriority := 2;
    if self.priorityButton3.Checked	= True then
      checkPriority := 3;
  end;
function TleaveRequestForm.checkAvailableRequests(): boolean;
  begin
    try
      with dbConnection.dbForm.requestLeaveQ do
      begin
        SetVariable('crew_id', Self.m_userId);
        SetVariable('priority', checkPriority());
        Execute;
      end;
    except
        ShowMessage('Priority used!');
    end;
    if dbConnection.dbForm.requestLeaveQ.Eof then
    begin
      checkAvailableRequests := True;
      ShowMessage('2222222');
    end
    else
    begin
      checkAvailableRequests := False;
      ShowMessage('111111111');
    end;
  end;
  procedure insertRequest();
  begin
     try
        with dbConnection.dbForm.requestLeaveQ do
          begin
              SetVariable('crew_id', Self.m_userId);
              SetVariable('start_date', DateToStr(Self.startDatePick.Date));
              SetVariable('end_date', DateToStr(Self.endDatePick.Date));
              SetVariable('priority', checkPriority());
              Execute;
          end;
     except
        ShowMessage('Request failed!');
     end;
  end;
end.
